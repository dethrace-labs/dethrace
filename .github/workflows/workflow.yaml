name: CICD

on: [push, pull_request]

jobs:

  build-nix:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - uses: actions/checkout@v3
      - name: Setup Ninja
        uses: ashutoshvarma/setup-ninja@master
        with:
          version: 1.10.2
      - name: Build
        id: build
        # env:
        #   MATRIX_PLATFORM: ${{ matrix.platform }}
        
        run: .github/scripts/build-${{ runner.os }}.sh
      - name: Test
        run: |
          cd build
          ctest --verbose
      - name: Upload artifact
        #if: startsWith(github.ref, 'refs/tags/') || github.ref_name == 'main'
        uses: actions/upload-artifact@v3
        with:
          name: ${{ steps.build.outputs.filename }}
          path: ${{ steps.build.outputs.filename }}

  # build-linux:
  #   runs-on: ubuntu-latest
  #   strategy:
  #     matrix:
  #       platform: [gcc]
  #   steps:
  #     - uses: actions/checkout@v3
  #     - name: Setup Ninja
  #       uses: ashutoshvarma/setup-ninja@master
  #       with:
  #         version: 1.10.2
  #     - name: Build
  #       id: build
  #       env:
  #         MATRIX_PLATFORM: ${{ matrix.platform }}
  #       run: .github/scripts/build-linux.sh
  #     - name: Test
  #       run: |
  #         cd build
  #         ctest --verbose
  #     - name: Upload artifact
  #       #if: startsWith(github.ref, 'refs/tags/') || github.ref_name == 'main'
  #       uses: actions/upload-artifact@v3
  #       with:
  #         name: ${{ steps.build.outputs.filename }}
  #         path: ${{ steps.build.outputs.filename }}

  # build-macos:
  #   runs-on: macos-latest
  #   steps:
  #     - uses: actions/checkout@v3
  #     - name: Setup Ninja
  #       uses: ashutoshvarma/setup-ninja@master
  #       with:
  #         version: 1.10.2
  #     - name: Build
  #       run: |
  #         .github/scripts/build-macos.sh
  #     - name: Test
  #       run: |
  #         cd build
  #         ctest --verbose
  #     - name: Upload artifact
  #       #if: startsWith(github.ref, 'refs/tags/') || github.ref_name == 'main'
  #       uses: actions/upload-artifact@v3
  #       with:
  #         name: ${{ steps.build.outputs.filename }}
  #         path: ${{ steps.build.outputs.filename }}

  build-windows:
    runs-on: windows-2019
    strategy:
      matrix:
        platform: [x86, amd64]
    steps:
      - uses: actions/checkout@v3
      - name: Setup Ninja
        uses: ashutoshvarma/setup-ninja@master
        with:
          version: 1.10.2
      - uses: ilammy/msvc-dev-cmd@v1.4.1
        with:
          arch: ${{ matrix.platform }}
      - name: Build
        id: build
        run: |
          .github/scripts/build-msvc.ps1
        env:
          MATRIX_PLATFORM: ${{ matrix.platform }}
      - name: Test
        run: |
          cd build
          ctest --verbose -C RelWithDebInfo
      - name: Upload artifact
        #if: startsWith(github.ref, 'refs/tags/') || github.ref_name == 'main'
        uses: actions/upload-artifact@v3
        with:
          name: ${{ steps.build.outputs.filename }}
          path: ${{ steps.build.outputs.filename }}


  create-release:
    needs: [build-nix, build-windows]
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    steps:
      - name: Fetch build artifacts
        uses: actions/download-artifact@v3
        with:
          path: artifacts
      - name: Create release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          draft: false
          prerelease: false
          name: Dethrace ${{github.ref_name}}
          generate_release_notes: true
          files: |
            artifacts/**